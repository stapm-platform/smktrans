---
title: "Smoking State Transition Probability Estimates: `r params$config$country`"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
    df_print: paged
params:
  config: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE, 
  warning = FALSE, 
  message = FALSE,
  fig.width = 9, 
  fig.height = 6
)

library(data.table)
library(ggplot2)
library(plotly)
library(DT)
library(viridis)

# 1. Unpack Config & Load Data
cfg <- params$config
out_dir <- file.path(cfg$path, "outputs")

# Helper to load specific result files
get_res <- function(type) {
  f_name <- paste0(type, "_forecast_data_", cfg$country, ".rds")
  f_path <- file.path(out_dir, f_name)
  if(file.exists(f_path)) return(readRDS(f_path))
  return(NULL)
}

init_dt <- get_res("init")
quit_dt <- get_res("quit")
rel_dt  <- get_res("relapse")

# Basic color scale
imd_pal <- viridis::viridis(5, option = "D", end = 0.9)

# --- GITHUB DOWNLOAD LINK SETUP ---
# Replace this with your actual repo details
gh_user <- "stapm-platform"  # or your username
gh_repo <- "smktrans"
gh_branch <- "master"

# Construct the filename of the Excel report
excel_name <- paste0("SmokeStateTransProbs_", cfg$country, "_", Sys.Date(), ".xlsx")

download_url <- paste0("[https://github.com/](https://github.com/)", gh_user, "/", gh_repo, "/raw/", gh_branch, "/transition_probability_estimates/outputs/", excel_name)
```

# Executive Summary

**Analysis Region:** `r cfg$country`  
**Data Source:** `r cfg$survey_name` (`r cfg$first_year` - `r cfg$last_year`)  
**Target Smokefree Year:** `r cfg$smokefree_target_year`

This report visualizes the estimated transition probabilities used in the simulation model. 

<a href="`r download_url`" class="btn btn-primary" role="button" style="color: white; text-decoration: none; padding: 10px 20px; background-color: #007bff; border-radius: 5px;">
  <i class="fa fa-download"></i> Download Full Excel Estimates
</a>

---

# 1. Initiation (Start Smoking)

```{r init_trend}
if(!is.null(init_dt)) {
  # Filter for young adults (target group for initiation)
  young_adults <- init_dt[age <= 30]
  
  # Aggregate trend
  trend_init <- young_adults[, .(p = mean(p_start)), by = .(year, sex, imd_quintile)]
  
  g <- ggplot(trend_init, aes(x = year, y = p, color = imd_quintile)) +
    geom_line() +
    facet_wrap(~sex) +
    scale_color_manual(values = imd_pal) +
    labs(title = "Mean Initiation Probability (Age <= 30)", 
         y = "Probability", x = "Year") +
    theme_minimal()
  
  ggplotly(g)
} else {
  cat("No Initiation Data Found.")
}
```

### Age Profile (Snapshot: 2024)

```{r init_age}
if(!is.null(init_dt)) {
  # Take a snapshot year
  snap <- init_dt[year == 2024 & age <= 30]
  
  g2 <- ggplot(snap, aes(x = age, y = p_start, color = sex)) +
    geom_line(linewidth = 1) +
    labs(title = "Initiation by Age (Year 2024)", y = "Probability") +
    theme_minimal()
    
  ggplotly(g2)
}
```

---

# 2. Quitting (Cessation)

```{r quit_trend}
if(!is.null(quit_dt)) {
  # Aggregate trend
  trend_quit <- quit_dt[, .(p = mean(p_quit)), by = .(year, sex, imd_quintile)]
  
  g3 <- ggplot(trend_quit, aes(x = year, y = p, color = imd_quintile)) +
    geom_line() +
    facet_wrap(~sex) +
    scale_color_manual(values = imd_pal) +
    labs(title = "Mean Quit Probability (All Ages)", 
         y = "Probability", x = "Year") +
    theme_minimal()
  
  ggplotly(g3)
}
```

### Quit Rates Table (2024)

```{r quit_table}
if(!is.null(quit_dt)) {
  # Create a clean table for the analyst
  t_dt <- quit_dt[year == 2024, .(sex, age, imd_quintile, p_quit)]
  
  datatable(t_dt, 
            filter = 'top', 
            rownames = FALSE,
            options = list(pageLength = 10, autoWidth = TRUE)) %>%
    formatRound(columns = "p_quit", digits = 4)
}
```

---

# 3. Relapse

```{r rel_trend}
if(!is.null(rel_dt)) {
  # Relapse depends heavily on 'time since quit' (tsq)
  # Let's look at the decay curve
  
  rel_curve <- rel_dt[year == 2024, .(p = mean(p_relapse)), by = .(time_since_quit, sex)]
  
  g4 <- ggplot(rel_curve, aes(x = time_since_quit, y = p, color = sex)) +
    geom_line(linewidth = 1) +
    labs(title = "Relapse Decay Curve (Year 2024)", 
         x = "Years Since Quitting", y = "Probability") +
    theme_minimal()
  
  ggplotly(g4)
}
```

---
*Report generated on `r Sys.Date()` using `smktrans`.*